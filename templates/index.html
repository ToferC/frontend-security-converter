{% extends "base.html" %}

{% block content %}
        <div class="col m-md-2 m-1">
            <div class="mb-4">
                <br>
                <h1 class="mb-3">{{ fluent(key="welcome-to", lang=lang) }}</h1>

                {% if session_user != "" %}
                    <a href="/{{ lang }}/conversion_request" class="btn btn-primary btn-lg shadow-sm">
                        <i class="bi bi-plus-circle"></i> Create Conversion Request
                    </a>
                {% endif %}
            </div>

            <div class="mb-4">

                <div class="row mb-4">
                <div class="col-md-6 mb-3">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-info text-white">
                            <h3 class="mb-0 h5">üè∑Ô∏è Search by Tag</h3>
                        </div>
                        <div class="card-body">
                            <p class="text-muted small mb-2">Find documents by tag keywords</p>
                            <div class="input-group">
                                <input id="tagSearchbar" class="form-control" type="text" placeholder="Enter tag (e.g., sigint, logistics)" aria-label="Search Tag">
                                <button class="btn btn-info" id="tagSearch" type="button">
                                    Search
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-primary text-white">
                            <h3 class="mb-0 h5">üìÇ Search by Domain</h3>
                        </div>
                        <div class="card-body">
                            <p class="text-muted small mb-2">Find documents by mission domain</p>
                            <div class="input-group">
                                <input id="domainSearchbar" class="form-control" type="text" placeholder="Enter domain (e.g., INTELLIGENCE)" aria-label="Search Domain">
                                <button class="btn btn-primary" id="domainSearch" type="button">
                                    Search
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
                <h2 class="h3 mb-3">Authorities by Nation</h2>

                {% if authorities %}
                    {% set nations_map = authorities | group_by(attribute="nation.nationName") %}

                    {# Extract nation names into an array and sort them #}
                    {% set_global nation_names = [] %}
                    {% for nation_name, auths in nations_map %}
                        {% set_global nation_names = nation_names | concat(with=nation_name) %}
                    {% endfor %}

                    <div class="row">
                        {% for nation_name in nation_names | sort %}
                            {% set nation_authorities = nations_map[nation_name] %}
                            {% if nation_authorities %}
                                <div class="col-md-6 col-lg-4 mb-3">
                                    <div class="card shadow-sm h-100">
                                        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                            <h3 class="mb-0 h6">{{ nation_name }}</h3>
                                            {% if nation_authorities[0].nation %}
                                                <span class="badge bg-light text-dark">{{ nation_authorities[0].nation.nationCode }}</span>
                                            {% endif %}
                                        </div>
                                        <div class="card-body p-0">
                                            <div class="list-group list-group-flush">
                                                {% for auth in nation_authorities %}
                                                    <a href="/{{ lang }}/authority/{{ auth.id }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-2 px-3">
                                                        <span class="small">{{ auth.name }}</span>
                                                        <i class="bi bi-chevron-right"></i>
                                                    </a>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-info shadow-sm" role="alert">
                        <i class="bi bi-info-circle-fill"></i> No authorities available.
                    </div>
                {% endif %}
            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-secondary text-white">
                    <h3 class="mb-0 h5">Search User by Name</h3>
                </div>
                <div class="card-body">
                    <div class="input-group">
                        <input id="personSearchbar" class="form-control form-control-lg" type="text" placeholder="Enter name here" aria-label="Search Person">
                        <button class="btn btn-dark btn-lg" id="peopleSearch" type="button">
                            <i class="bi bi-search"></i> Search
                        </button>
                    </div>
                </div>
            </div>
        </div>
{% endblock content %}

{% block scripts %}
<script>
    // Tag search
    document.getElementById("tagSearch").addEventListener("click", tagSearch);
    document.getElementById("tagSearchbar").addEventListener("keypress", function(e) {
        if (e.key === "Enter") tagSearch();
    });

    function tagSearch() {
        var tag = document.getElementById("tagSearchbar").value.trim();
        if (tag) {
            window.location.href = '/{{ lang }}/search_metadata/pattern/' + encodeURIComponent(tag);
        }
    }

    // Domain search
    document.getElementById("domainSearch").addEventListener("click", domainSearch);
    document.getElementById("domainSearchbar").addEventListener("keypress", function(e) {
        if (e.key === "Enter") domainSearch();
    });

    function domainSearch() {
        var domain = document.getElementById("domainSearchbar").value.trim();
        if (domain) {
            window.location.href = '/{{ lang }}/metadata/domain/' + encodeURIComponent(domain);
        }
    }

    // People search
    document.getElementById("peopleSearch").addEventListener("click", peopleSearch);
    document.getElementById("personSearchbar").addEventListener("keypress", function(e) {
        if (e.key === "Enter") peopleSearch();
    });

    function peopleSearch() {
        var result = document.getElementById("personSearchbar").value;
        window.location.href = '/{{ lang }}/person_by_name/' + result;
    }
</script>
{% endblock scripts%}